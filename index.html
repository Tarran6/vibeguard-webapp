<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>VibeGuard ‚Äî Web3 Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0d0d1a; --card: #16162a; --border: #2a2a4a;
      --accent: #7c5cfc; --accent2: #4fc3f7;
      --text: #e8e8f0; --muted: #8888aa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, system-ui, sans-serif;
      background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; gap: 20px;
    }
    .logo { font-size: 50px; margin-bottom: -10px; filter: drop-shadow(0 0 10px var(--accent)); }
    h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; 
         background: linear-gradient(135deg, var(--accent), var(--accent2)); 
         -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; 
            padding: 24px; width: 100%; max-width: 340px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .btn {
      display: flex; align-items: center; gap: 15px; width: 100%;
      background: #1e1e38; border: 1px solid var(--border); border-radius: 16px;
      padding: 16px; margin-bottom: 12px; cursor: pointer; color: white; 
      font-weight: 600; transition: all 0.2s ease;
    }
    .btn:active { transform: scale(0.96); }
    .btn.primary { background: var(--accent); border: none; justify-content: center; }
    .btn-icon { font-size: 24px; }
    .status-box { display: none; text-align: center; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); 
               border-top-color: var(--accent); border-radius: 50%; 
               animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .footer-note { font-size: 12px; color: var(--muted); text-align: center; line-height: 1.4; }
  </style>
</head>
<body>

<div class="logo">üõ°Ô∏è</div>
<h1>VibeGuard Sentinel</h1>

<div class="card" id="mainCard">
  <div id="selectorView">
    <p style="text-align: center; color: var(--muted); margin-bottom: 20px; font-size: 14px;">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
    
    <button class="btn" onclick="redirectToWallet('metamask')">
      <span class="btn-icon">ü¶ä</span>
      <span>MetaMask App</span>
    </button>
    
    <button class="btn" onclick="redirectToWallet('trust')">
      <span class="btn-icon">üîµ</span>
      <span>Trust Wallet App</span>
    </button>

    <div style="height: 1px; background: var(--border); margin: 15px 0;"></div>
    
    <button class="btn" onclick="tryInternalConnect()">
      <span class="btn-icon">‚ö°</span>
      <span>–Ø —É–∂–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∫–æ—à–µ–ª—å–∫–∞</span>
    </button>
  </div>

  <div id="statusView" class="status-box">
    <div id="loader" class="spinner"></div>
    <p id="statusTitle" style="font-weight: bold; margin-bottom: 10px; font-size: 17px;"></p>
    <p id="statusMsg" style="color: var(--muted); font-size: 14px; margin-bottom: 20px;"></p>
    <button class="btn" onclick="location.reload()" style="background: transparent; font-size: 13px;">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
</div>

<p class="footer-note">üîí –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.<br>–ü–æ–¥–ø–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –∞–∫—Ç–∏–≤–∞–º.</p>

<script>
  const tg = window.Telegram.WebApp;
  const NONCE = new URLSearchParams(window.location.search).get("nonce") || "";
  
  tg.expand();
  tg.ready();

  function showStatus(title, msg, showLoader = true) {
    document.getElementById('selectorView').style.display = 'none';
    document.getElementById('statusView').style.display = 'block';
    document.getElementById('loader').style.display = showLoader ? 'block' : 'none';
    document.getElementById('statusTitle').textContent = title;
    document.getElementById('statusMsg').textContent = msg;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
  function redirectToWallet(type) {
    const domain = window.location.host + window.location.pathname;
    const fullUrl = window.location.href;
    
    if (type === 'metamask') {
      // –ü—Ä—è–º–∞—è –≥–ª—É–±–æ–∫–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è DApp –±—Ä–∞—É–∑–µ—Ä–∞ MetaMask
      window.location.href = "https://metamask.app.link/dapp/" + domain + "?nonce=" + NONCE;
    } else if (type === 'trust') {
      // –°—Å—ã–ª–∫–∞ –¥–ª—è Trust Wallet
      window.location.href = "https://link.trustwallet.com/open_url?url=" + encodeURIComponent(fullUrl);
    }
    
    showStatus("–ü–µ—Ä–µ—Ö–æ–¥–∏–º...", "–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ—à–µ–ª—å–∫–∞.");
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–∫–æ–≥–¥–∞ —é–∑–µ—Ä —É–∂–µ –≤–Ω—É—Ç—Ä–∏ MetaMask/Trust –∏–ª–∏ –Ω–∞ –ü–ö)
  async function tryInternalConnect() {
    if (typeof window.ethereum === 'undefined') {
      showStatus("–ö–æ—à–µ–ª–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É 'App' –≤—ã—à–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω—É—Ç—Ä–∏ –∫–æ—à–µ–ª—å–∫–∞.", false);
      return;
    }

    try {
      showStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ", "–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∞–¥—Ä–µ—Å—É –≤ –∫–æ—à–µ–ª—å–∫–µ...");
      const provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      
      showStatus("–ü–æ–¥–ø–∏—Å—å", "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...");
      const message = "VibeGuard verification: " + NONCE;
      const signature = await signer.signMessage(message);

      showStatus("–ì–æ—Ç–æ–≤–æ!", "–ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
      tg.sendData(JSON.stringify({ address: accounts[0], signature: signature }));
      
      setTimeout(() => tg.close(), 1200);
    } catch (e) {
      console.error(e);
      showStatus("–û—à–∏–±–∫–∞", e.message.includes("user rejected") ? "–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∑–∞–ø—Ä–æ—Å" : "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è", false);
    }
  }

  // –ê–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –º—ã —É–∂–µ –∑–∞—à–ª–∏ —á–µ—Ä–µ–∑ –∫–æ—à–µ–ª–µ–∫, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç—Ç–æ
  if (typeof window.ethereum !== 'undefined') {
    console.log("Web3 Detected");
  }
</script>
</body>
</html>
